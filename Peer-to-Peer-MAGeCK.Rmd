---
title: "Peer-to-Peer-MAGeCK"
author: "Juan Martinez-Villalobos"
date: "2025-02-20"
output: html_document
---

# Install libraries
```{r}

# Directly from R
install.packages("ggpubr")
install.packages('corrplot')
install.packages("RColorBrewer")
install.packages("tidyverse")
install.packages("ggrepel")
install.packages("ggstatsplot")

# From Bioconductor
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("MAGeCKFlute")


```

# Load libraries
```{r Libraries, message=FALSE, warning=FALSE}

library(ggpubr)
library(corrplot)
library(RColorBrewer)
library(tidyverse)
library(MAGeCKFlute)
library(ggrepel)
library(ggstatsplot)

```

# Load MAGeCK data
```{r}

# Load count summary and normalized count data
count_summary <- read.delim("FASTQ/A549.countsummary.txt", header = T)
raw_count_data <- read.delim("FASTQ/A549.count.txt", header = T) 
norm_count_data <- read.delim("FASTQ/A549.count_normalized.txt", header = T) 

```



# Define colors and order for the samples
```{r}

# Add a column with the Day information
count_summary$Day <- c(rep("D0", 2),  # D0R1 - D0R2
                       rep("D21", 7)) # IVR1 - IVR2, XENOR1 - XENOR2 - XENOR3 - XENOR4 - XENOR5

# Add a column with the Type of culture information
count_summary$Type <- c(rep("In Vitro", 4),  # D0R1 - D0R2,  IVR1 - IVR2
                        rep("In Vivo", 5)) # XENOR1 - XENOR2 - XENOR3 - XENOR4 - XENOR5

# Define color scheme
Colors <- c( "D0R1" = "#9f9f9f", "D0R2" = "#424242",
             "IVR1" = "#5f638f","IVR2" = "#36234e",
             "XENOR1" = "#a3d8ff", "XENOR2" = "#80cfff", 
             "XENOR3" = "#4a7ebb", "XENOR4" = "#1f4c7a", "XENOR5" = "#0f2e4d")

# Define the desired order of labels
Order <- c("D0R1", "D0R2", 
           "IVR1", "IVR2", 
           "XENOR1", "XENOR2", 
           "XENOR3", "XENOR4", "XENOR5")

```

# Gini index
```{r}

count_summary %>%
  # Filter to only include rows with Labels in the Order vector
  filter(Label %in% Order) %>%
  # Convert Label to factor with specific order
  mutate(Label = factor(Label, levels = Order)) %>%
  ggbarplot( x = "Label", y = "GiniIndex",
             fill = "Label", lab.pos = "out", xlab = "Sample",
             ggtheme = theme_pubclean(base_size = 18),
             palette = Colors) +
  theme(legend.position = "right")

# Save the plot
ggsave("MAGeCK-Gini-Index.pdf", 
       width = 12, 
       height = 6, 
       units = "in",
       dpi = 300)

```

# Lost sgRNA
```{r}

# Create the plot
missed_plot <- ggbarplot(count_summary,
                         x = "Label", 
                         y = "Zerocounts",
                         fill = "Label", 
                         lab.pos = "out", 
                         xlab = "Sample",
                         ggtheme = theme_pubclean(base_size = 18),
                         palette = Colors) +
  theme(legend.position = "right")

# Save the plot
ggsave("MAGeCK-Lost-sgRNAs.pdf", 
       plot = missed_plot,
       width = 12, 
       height = 6, 
       units = "in", 
       dpi = 300)

```

# Ratio of mapped reads
```{r}

# Calculate mapped and unmapped reads with percentages
plot_data <- count_summary %>%
  mutate(Mapped = round(Reads * Percentage),
         Unmapped = Reads - Mapped,
         Mapped_Percentage = round(Percentage * 100),
         Unmapped_Percentage = round((1 - Percentage) * 100)) %>%
  select(Label, Mapped, Unmapped, Mapped_Percentage, Unmapped_Percentage) %>%
  tidyr::pivot_longer(cols = c(Mapped, Unmapped), names_to = "category", values_to = "count") %>%
  mutate(Label = factor(Label, levels = Order),
         category = factor(category, levels = c("Unmapped", "Mapped")),
         percentage = ifelse(category == "Mapped", Mapped_Percentage, Unmapped_Percentage))

# Map ratio plot
ggbarplot(plot_data, x = "Label", y = "count",
          fill = "category", color = "category",
          palette = c("#813e3e", "#005073"),
          position = position_stack(),
          xlab = "", ylab = "Reads") +
  geom_text(aes(label = sprintf("%d%%", percentage), group = category), 
            position = position_stack(vjust = 0.5), color = "white", size = 3.5) +
  theme_pubclean(base_size = 18) +
  theme(legend.position = "right")

# Save the plot
ggsave("MAGeCK-Mapped-Ratio.pdf", 
       width = 12, 
       height = 7, 
       units = "in", 
       dpi = 300)


```

